<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <title>ASTRO4 - Tu Energ√≠a de Hoy</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Nunito:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#c9a96e">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Nunito', sans-serif;
      background: linear-gradient(180deg, #faf7f2 0%, #f5ede3 100%);
      min-height: 100vh; color: #3d3527;
    }
    .container { max-width: 420px; margin: 0 auto; padding: 16px; }
    
    /* Header */
    header { display: flex; align-items: center; justify-content: center; padding: 12px 0; position: relative; }
    .back-btn { position: absolute; left: 0; color: #8b7355; text-decoration: none; font-size: 1.2rem; padding: 8px; }
    header h1 { font-family: 'Cormorant Garamond', serif; font-size: 1.6rem; color: #5c4d3c; letter-spacing: 2px; }
    
    /* Lang Toggle */
    .lang-toggle { position: absolute; right: 0; display: flex; gap: 2px; background: rgba(255,255,255,0.8); border-radius: 16px; padding: 3px; }
    .lang-btn { padding: 4px 10px; border: none; border-radius: 12px; font-size: 0.7rem; font-weight: 600; cursor: pointer; background: transparent; color: #8b7d6b; }
    .lang-btn.active { background: #c9a96e; color: white; }
    
    /* Greeting */
    .greeting { text-align: center; padding: 16px 0; }
    .greeting h2 { font-family: 'Cormorant Garamond', serif; font-size: 1.5rem; color: #5c4d3c; }
    .greeting .date { font-size: 0.85rem; color: #8b7d6b; margin-top: 4px; }
    
    /* Cards */
    .card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 20px rgba(93,77,60,0.08); }
    .card h3 { font-family: 'Cormorant Garamond', serif; font-size: 1.1rem; color: #5c4d3c; margin-bottom: 12px; }
    
    /* Energy Items */
    .energy-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0ebe3; }
    .energy-item:last-child { border-bottom: none; }
    .energy-item .icon { font-size: 1.5rem; margin-right: 12px; }
    .energy-item .label { font-size: 0.75rem; color: #a99d8d; }
    .energy-item .value { font-size: 0.95rem; color: #5c4d3c; font-weight: 500; }
    
    /* Actions */
    .action-item { display: flex; align-items: flex-start; padding: 10px 0; border-bottom: 1px solid #f0ebe3; }
    .action-item:last-child { border-bottom: none; }
    .action-number { width: 24px; height: 24px; background: linear-gradient(135deg, #c9a96e, #a68b5b); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; margin-right: 12px; flex-shrink: 0; }
    .action-text { font-size: 0.9rem; color: #5c4d3c; }
    
    /* Warning */
    .warning-card { background: linear-gradient(135deg, #fff5f5, #fff0f0); border: 1px solid #f5d5d5; }
    .warning-content { display: flex; align-items: center; }
    .warning-icon { font-size: 1.3rem; margin-right: 10px; }
    .warning-text { font-size: 0.9rem; color: #8b5a5a; }
    
    /* Extras Grid */
    .extras-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .extra-item { text-align: center; padding: 12px 8px; background: #faf7f2; border-radius: 12px; }
    .extra-item .icon { font-size: 1.3rem; }
    .extra-item .label { font-size: 0.65rem; color: #a99d8d; margin: 4px 0; }
    .extra-item .value { font-size: 0.85rem; color: #5c4d3c; font-weight: 600; }
    
    /* Consult Section */
    .consult-card { background: linear-gradient(135deg, #f9f5f0, #f5ede3); }
    .consult-card textarea { width: 100%; padding: 12px; border: 1px solid #e5ddd3; border-radius: 12px; background: white; color: #3d3527; font-family: 'Nunito', sans-serif; font-size: 0.9rem; resize: none; }
    .consult-card textarea:focus { outline: none; border-color: #c9a96e; }
    .btn-consult { width: 100%; padding: 14px; background: linear-gradient(135deg, #c9a96e, #a68b5b); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 12px; }
    .btn-consult:disabled { opacity: 0.7; }
    .response-box { margin-top: 12px; padding: 16px; background: white; border-radius: 12px; font-size: 0.9rem; line-height: 1.5; display: none; }
    .btn-another { margin-top: 10px; padding: 10px 20px; background: #e5ddd3; color: #5c4d3c; border: none; border-radius: 10px; cursor: pointer; display: none; }
    
    /* Share Button */
    .btn-share { width: 100%; padding: 14px; background: white; color: #8b7355; border: 2px solid #c9a96e; border-radius: 12px; font-size: 0.95rem; font-weight: 600; cursor: pointer; margin-bottom: 16px; }
    
    /* Footer */
    footer { text-align: center; padding: 16px; color: #a99d8d; font-size: 0.8rem; }
    footer a { color: #c9a96e; text-decoration: none; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <a href="index.html" class="back-btn">‚Üê</a>
      <h1>‚úß ASTRO4 ‚úß</h1>
      <div class="lang-toggle">
        <button class="lang-btn active" onclick="setLang('es')" id="btn-es">ES</button>
        <button class="lang-btn" onclick="setLang('en')" id="btn-en">EN</button>
      </div>
    </header>
    
    <div class="greeting">
      <h2><span data-i18n="hello">Hola</span>, <span id="user-name">...</span></h2>
      <p class="date" id="today-date">...</p>
    </div>
    
    <div class="card">
      <h3 data-i18n="yourEnergy">‚òÄÔ∏è Tu Energ√≠a Hoy</h3>
      <div class="energy-item"><span class="icon">‚òÄÔ∏è</span><div><div class="label" data-i18n="western">Occidental</div><div class="value" id="western-sign">...</div></div></div>
      <div class="energy-item"><span class="icon">üêâ</span><div><div class="label" data-i18n="chinese">Chino</div><div class="value" id="chinese-sign">...</div></div></div>
      <div class="energy-item"><span class="icon">üïâÔ∏è</span><div><div class="label" data-i18n="vedic">V√©dico</div><div class="value" id="vedic-sign">...</div></div></div>
      <div class="energy-item"><span class="icon">üî¢</span><div><div class="label" data-i18n="numerology">Numerolog√≠a</div><div class="value" id="numerology">...</div></div></div>
    </div>
    
    <div class="card">
      <h3 data-i18n="doToday">‚úÖ Haz Esto Hoy</h3>
      <div class="action-item"><span class="action-number">1</span><span class="action-text" id="action-1">...</span></div>
      <div class="action-item"><span class="action-number">2</span><span class="action-text" id="action-2">...</span></div>
      <div class="action-item"><span class="action-number">3</span><span class="action-text" id="action-3">...</span></div>
    </div>
    
    <div class="card warning-card">
      <h3 data-i18n="avoidToday">‚ö†Ô∏è Evita Hoy</h3>
      <div class="warning-content"><span class="warning-icon">‚ö†Ô∏è</span><span class="warning-text" id="warning-text">...</span></div>
    </div>
    
    <div class="card">
      <div class="extras-grid">
        <div class="extra-item"><span class="icon">üé®</span><div class="label" data-i18n="color">Color</div><div class="value" id="lucky-color">...</div></div>
        <div class="extra-item"><span class="icon">üî¢</span><div class="label" data-i18n="number">N√∫mero</div><div class="value" id="lucky-number">...</div></div>
        <div class="extra-item"><span class="icon">‚è∞</span><div class="label" data-i18n="powerHour">Hora de Poder</div><div class="value" id="power-hour">...</div></div>
      </div>
    </div>
    
    <div class="card consult-card">
      <h3 data-i18n="consultTitle">üíé Consulta con Tu Gu√≠a</h3>
      <p style="font-size:0.85rem;color:#8b7d6b;margin-bottom:12px;" data-i18n="consultSub">¬øDudas sobre amor, carrera o dinero?</p>
      <textarea id="pregunta" data-i18n-placeholder="consultPlaceholder" placeholder="Escribe tu pregunta..." rows="3"></textarea>
      <button class="btn-consult" id="btn-consultar" onclick="enviarConsulta()" data-i18n="consultBtn">‚ú® Consultar</button>
      <div class="response-box" id="respuesta-consulta"></div>
      <button class="btn-another" id="btn-otra" onclick="otraConsulta()" data-i18n="anotherBtn">üîÑ Otra Consulta</button>
    </div>
    
    <button class="btn-share" onclick="shareResults()" data-i18n="shareBtn">üì§ Compartir mi energ√≠a de hoy</button>
    
    <footer>
      <p>üêù <span data-i18n="madeWith">Hecho con ‚ô• por</span> <a href="#">Colmena (C6)</a></p>
      <p><a href="#" onclick="showPrivacy()" data-i18n="privacy">Privacidad</a></p>
    </footer>
  </div>
  
  <script src="js/astro-calc.js"></script>
  <script src="js/actions-engine.js"></script>
  <script>
    const i18n = {
      es: {
        hello: "Hola", yourEnergy: "‚òÄÔ∏è Tu Energ√≠a Hoy",
        western: "Occidental", chinese: "Chino", vedic: "V√©dico", numerology: "Numerolog√≠a",
        doToday: "‚úÖ Haz Esto Hoy", avoidToday: "‚ö†Ô∏è Evita Hoy",
        color: "Color", number: "N√∫mero", powerHour: "Hora de Poder",
        consultTitle: "üíé Consulta con Tu Gu√≠a", consultSub: "¬øDudas sobre amor, carrera o dinero?",
        consultPlaceholder: "Escribe tu pregunta...", consultBtn: "‚ú® Consultar",
        consulting: "üîÆ Consultando...", anotherBtn: "üîÑ Otra Consulta",
        shareBtn: "üì§ Compartir mi energ√≠a de hoy", madeWith: "Hecho con ‚ô• por", privacy: "Privacidad",
        privacyMsg: "ASTRO4 respeta tu privacidad. Tus datos se guardan solo en tu dispositivo.",
        guideTitle: "üîÆ Tu Gu√≠a:", errorMsg: "‚ùå Error. Intenta de nuevo.",
        askFirst: "Escribe una pregunta primero", copied: "¬°Copiado!",
        life: "Vida", of: "de", personalDay: "D√≠a Personal"
      },
      en: {
        hello: "Hello", yourEnergy: "‚òÄÔ∏è Your Energy Today",
        western: "Western", chinese: "Chinese", vedic: "Vedic", numerology: "Numerology",
        doToday: "‚úÖ Do This Today", avoidToday: "‚ö†Ô∏è Avoid Today",
        color: "Color", number: "Number", powerHour: "Power Hour",
        consultTitle: "üíé Consult Your Guide", consultSub: "Questions about love, career or money?",
        consultPlaceholder: "Write your question...", consultBtn: "‚ú® Consult",
        consulting: "üîÆ Consulting...", anotherBtn: "üîÑ Another Question",
        shareBtn: "üì§ Share my energy today", madeWith: "Made with ‚ô• by", privacy: "Privacy",
        privacyMsg: "ASTRO4 respects your privacy. Your data is stored only on your device.",
        guideTitle: "üîÆ Your Guide:", errorMsg: "‚ùå Error. Try again.",
        askFirst: "Write a question first", copied: "Copied!",
        life: "Life", of: "of", personalDay: "Personal Day"
      }
    };
    
    var urlParams = new URLSearchParams(window.location.search);
    var nombre = urlParams.get('nombre');
    var fechaStr = urlParams.get('fecha');
    var currentLang = urlParams.get('lang') || localStorage.getItem('astro4_lang') || 'es';
    
    if (!nombre || !fechaStr) { window.location.href = 'index.html'; }
    
    function setLang(lang) {
      currentLang = lang;
      localStorage.setItem('astro4_lang', lang);
      document.getElementById('btn-es').classList.toggle('active', lang === 'es');
      document.getElementById('btn-en').classList.toggle('active', lang === 'en');
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (i18n[lang][key]) el.textContent = i18n[lang][key];
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (i18n[lang][key]) el.placeholder = i18n[lang][key];
      });
      updateDate();
      updateSigns();
    }
    
    function showPrivacy() { alert(i18n[currentLang].privacyMsg); }
    
    var birthDate = new Date(fechaStr);
    var western, chinese, vedic, numerology, result;
    
    function updateDate() {
      var today = new Date();
      var locale = currentLang === 'es' ? 'es-MX' : 'en-US';
      document.getElementById('today-date').textContent = today.toLocaleDateString(locale, {weekday:'long',year:'numeric',month:'long',day:'numeric'});
    }
    
    function updateSigns() {
      western = getWesternSign(birthDate, currentLang);
      chinese = getChineseZodiac(birthDate.getFullYear(), currentLang);
      vedic = getNakshatra(birthDate);
      numerology = getNumerology(birthDate, nombre, currentLang);
      result = generateActions(western, chinese, numerology, birthDate, currentLang);
      
      var t = i18n[currentLang];
      document.getElementById('western-sign').textContent = western.name + ' (' + western.element + ')';
      document.getElementById('chinese-sign').textContent = chinese.animal + ' ' + chinese.element + ' ' + chinese.yinYang;
      document.getElementById('vedic-sign').textContent = vedic.nakshatra;
      document.getElementById('numerology').textContent = numerology.lifeNumber + ' (' + numerology.lifeMeaning.keyword + ') ‚Ä¢ Alma ' + numerology.soulNumber;
      
      document.getElementById('action-1').textContent = result.actions[0];
      document.getElementById('action-2').textContent = result.actions[1];
      document.getElementById('action-3').textContent = result.actions[2];
      document.getElementById('warning-text').textContent = result.warning;
      document.getElementById('lucky-color').textContent = result.color;
      document.getElementById('lucky-number').textContent = numerology.personalDay;
      document.getElementById('power-hour').textContent = result.hour;
    }
    
    document.getElementById('user-name').textContent = nombre;
    setLang(currentLang);
    
    function otraConsulta() {
      document.getElementById('pregunta').value = '';
      document.getElementById('respuesta-consulta').style.display = 'none';
      document.getElementById('btn-otra').style.display = 'none';
      var btn = document.getElementById('btn-consultar');
      btn.style.display = 'block';
      var t = i18n[currentLang];
      startRateLimitTimer(btn, t);
    }
    
    // Rate limiting - 60 segundos entre consultas
    var RATE_LIMIT_SECONDS = 60;
    var rateLimitInterval = null;
    
    function checkRateLimit() {
      var lastTime = localStorage.getItem('astro4_lastConsult');
      if (!lastTime) return 0;
      var elapsed = Math.floor((Date.now() - parseInt(lastTime)) / 1000);
      return Math.max(0, RATE_LIMIT_SECONDS - elapsed);
    }
    
    function startRateLimitTimer(btn, t) {
      var remaining = checkRateLimit();
      if (remaining <= 0) {
        btn.textContent = t.consultBtn;
        btn.disabled = false;
        return;
      }
      btn.disabled = true;
      btn.textContent = (currentLang === 'es' ? 'Espera ' : 'Wait ') + remaining + 's...';
      rateLimitInterval = setInterval(function() {
        remaining = checkRateLimit();
        if (remaining <= 0) {
          clearInterval(rateLimitInterval);
          btn.textContent = t.consultBtn;
          btn.disabled = false;
        } else {
          btn.textContent = (currentLang === 'es' ? 'Espera ' : 'Wait ') + remaining + 's...';
        }
      }, 1000);
    }
    
    async function enviarConsulta() {
      var pregunta = document.getElementById('pregunta').value;
      var t = i18n[currentLang];
      if (!pregunta.trim()) { alert(t.askFirst); return; }
      
      // Check rate limit
      var waitTime = checkRateLimit();
      if (waitTime > 0) {
        alert((currentLang === 'es' ? 'Espera ' : 'Wait ') + waitTime + (currentLang === 'es' ? ' segundos antes de consultar de nuevo' : ' seconds before consulting again'));
        return;
      }
      
      var btn = document.getElementById('btn-consultar');
      btn.textContent = t.consulting;
      btn.disabled = true;
      
      var perfil = {
        western: western.name + ' (' + western.element + ')',
        chinese: chinese.animal + ' ' + chinese.element + ' ' + chinese.yinYang,
        vedic: vedic.nakshatra,
        lifeNumber: numerology.lifeNumber,
        lifeMeaning: numerology.lifeMeaning.keyword,
        personalDay: numerology.personalDay
      };
      
      var nombreUsuario = localStorage.getItem('astro4_nombre') || '';
      var hoy = new Date();
      var fechaHoy = currentLang === 'es' ? 
        hoy.toLocaleDateString('es-ES', {weekday: 'long', day: 'numeric', month: 'long'}) :
        hoy.toLocaleDateString('en-US', {weekday: 'long', month: 'long', day: 'numeric'});
      
      var dayMeanings = {
        es: {1:'inicio', 2:'cooperaci√≥n', 3:'expresi√≥n', 4:'estructura', 5:'cambio', 6:'armon√≠a', 7:'reflexi√≥n', 8:'poder', 9:'cierre'},
        en: {1:'new beginnings', 2:'cooperation', 3:'expression', 4:'structure', 5:'change', 6:'harmony', 7:'reflection', 8:'power', 9:'completion'}
      };
      var dayMeaning = dayMeanings[currentLang][perfil.personalDay] || '';
      
      var promptText = currentLang === 'es' ? 
        'Responde en ESPA√ëOL a ' + nombreUsuario + '. ' +
        'FECHA: ' + fechaHoy + '. ' +
        'Eres un gu√≠a espiritual sabio y c√°lido. ' +
        '[CONTEXTO INTERNO - NO MENCIONAR: ' + nombreUsuario + ' es ' + perfil.western + ', ' + perfil.chinese + ', Nakshatra ' + perfil.vedic + ', Vida ' + perfil.lifeNumber + ', D√≠a ' + perfil.personalDay + '=' + dayMeaning + '] ' +
        'PREGUNTA: "' + pregunta + '". ' +
        'INSTRUCCIONES: 1.Dir√≠gete a ' + nombreUsuario + ' por su nombre. 2.Responde en 4-5 oraciones. 3.NO menciones signos, animales, n√∫meros ni sistemas astrol√≥gicos. 4.Da un consejo profundo y pr√°ctico para HOY. 5.Tono c√°lido como abuelo sabio que conoce bien a ' + nombreUsuario + '. 6.USA LENGUAJE NEUTRO (evita √©l/ella, usa t√∫).' :
        'Respond in ENGLISH to ' + nombreUsuario + '. ' +
        'DATE: ' + fechaHoy + '. ' +
        'You are a wise and warm spiritual guide. ' +
        '[INTERNAL CONTEXT - DO NOT MENTION: ' + nombreUsuario + ' is ' + perfil.western + ', ' + perfil.chinese + ', Nakshatra ' + perfil.vedic + ', Life ' + perfil.lifeNumber + ', Day ' + perfil.personalDay + '=' + dayMeaning + '] ' +
        'QUESTION: "' + pregunta + '". ' +
        'INSTRUCTIONS: 1.Address ' + nombreUsuario + ' by name. 2.Respond in 4-5 sentences. 3.DO NOT mention signs, animals, numbers or astrological systems. 4.Give deep and practical advice for TODAY. 5.Warm tone like a wise grandparent who knows ' + nombreUsuario + ' well. 6.USE NEUTRAL LANGUAGE (avoid he/she, use you).';
      
      try {
        var response = await fetch('/api/consulta', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: promptText })
        });
        var data = await response.json();
        document.getElementById('respuesta-consulta').style.display = 'block';
        document.getElementById('respuesta-consulta').innerHTML = '<strong>' + t.guideTitle + '</strong><br><br>' + data.respuesta;
        document.getElementById('btn-otra').style.display = 'block';
        btn.style.display = 'none';
        // Guardar timestamp para rate limiting
        localStorage.setItem('astro4_lastConsult', Date.now().toString());
      } catch (error) {
        document.getElementById('respuesta-consulta').style.display = 'block';
        document.getElementById('respuesta-consulta').innerHTML = t.errorMsg;
      }
      btn.textContent = t.consultBtn;
      btn.disabled = false;
    }
    
    function shareResults() {
      var t = i18n[currentLang];
      var text = currentLang === 'es' ?
        'üîÆ Mi energ√≠a ASTRO4:\n‚òÄÔ∏è ' + western.name + '\nüêâ ' + chinese.animal + '\nüïâÔ∏è ' + vedic.nakshatra + '\nüî¢ Vida ' + numerology.lifeNumber + '\n\nDescubre: https://astro3-lovat.vercel.app' :
        'üîÆ My ASTRO4 energy:\n‚òÄÔ∏è ' + western.name + '\nüêâ ' + chinese.animal + '\nüïâÔ∏è ' + vedic.nakshatra + '\nüî¢ Life ' + numerology.lifeNumber + '\n\nDiscover: https://astro3-lovat.vercel.app';
      if (navigator.share) {
        navigator.share({ title: 'ASTRO4', text: text });
      } else {
        navigator.clipboard.writeText(text).then(function() { alert(t.copied); });
      }
    }
  
    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('[SW] Registered'))
          .catch(err => console.log('[SW] Error:', err));
      });
    }

  </script>
</body>
</html>