<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <title>ASTRO4 - Tu Gu√≠a C√≥smica</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Nunito:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <style>
    :root {
      --bg-primary: #faf7f2;
      --bg-secondary: #f5ede3;
      --bg-card: #ffffff;
      --text-primary: #3d3527;
      --text-secondary: #8b7d6b;
      --text-title: #5c4d3c;
      --accent: #c9a96e;
      --accent-dark: #8b7355;
      --border: #e5ddd3;
    }
    [data-theme="dark"] {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-card: rgba(20, 20, 30, 0.8);
      --text-primary: #e8e6e3;
      --text-secondary: #a0a0a0;
      --text-title: #f0ede8;
      --accent: #d4b896;
      --accent-dark: #8b7355;
      --border: #2a2a3a;
    }
    #starfield-index {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
    }
    [data-theme="dark"] #starfield-index {
      display: block;
    }
    [data-theme="dark"] body {
      background: var(--bg-primary) !important;
      color: var(--text-primary);
    }
    [data-theme="dark"] .container {
      position: relative;
      z-index: 1;
    }
    [data-theme="dark"] header h1 {
      color: var(--text-title) !important;
    }
    [data-theme="dark"] header .subtitle {
      color: var(--text-secondary) !important;
    }
    [data-theme="dark"] .main-card {
      background: var(--bg-card) !important;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--border);
    }
    [data-theme="dark"] .main-card h2 {
      color: var(--text-title) !important;
    }
    [data-theme="dark"] .main-card p {
      color: var(--text-secondary) !important;
    }
    [data-theme="dark"] .form-group label {
      color: var(--text-title) !important;
    }
    [data-theme="dark"] .form-group input,
    [data-theme="dark"] .form-group select {
      background: rgba(30, 30, 40, 0.9) !important;
      border-color: var(--border) !important;
      color: var(--text-primary) !important;
    }
    [data-theme="dark"] .tradition-card {
      background: var(--bg-card) !important;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--border);
    }
    [data-theme="dark"] .tradition-card h3 {
      color: var(--text-title) !important;
    }
    [data-theme="dark"] .traditions-title {
      color: var(--text-title) !important;
    }
    [data-theme="dark"] .lang-toggle {
      background: rgba(20, 20, 30, 0.8) !important;
      border: 1px solid var(--border);
    }
    [data-theme="dark"] .lang-btn {
      color: var(--text-secondary) !important;
    }
    [data-theme="dark"] .lang-btn.active {
      background: var(--accent) !important;
      color: #0a0a0f !important;
    }
    [data-theme="dark"] footer {
      color: var(--text-secondary) !important;
    }
    [data-theme="dark"] footer a {
      color: var(--accent) !important;
    }
    .theme-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      cursor: pointer;
      font-size: 1.5rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    [data-theme="dark"] .theme-toggle {
      background: var(--bg-card);
      border: 1px solid var(--border);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: linear-gradient(180deg, #faf7f2 0%, #f5ede3 100%); min-height: 100vh; color: #3d3527; }
    .container { max-width: 420px; margin: 0 auto; padding: 16px; position: relative; }
    .lang-toggle { position: absolute; top: 75px; right: 16px; display: flex; gap: 4px; background: rgba(255,255,255,0.8); border-radius: 20px; padding: 4px; z-index: 10; }
    .lang-btn { padding: 6px 12px; border: none; border-radius: 16px; font-size: 0.8rem; font-weight: 600; cursor: pointer; background: transparent; color: #8b7d6b; transition: all 0.2s; }
    .lang-btn.active { background: #c9a96e; color: white; }
    .install-banner { background: linear-gradient(135deg, #c9a96e 0%, #8b7355 100%); color: white; padding: 12px 16px; border-radius: 12px; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px rgba(139, 115, 85, 0.3); }
    .install-banner p { font-size: 14px; }
    .install-banner button { background: white; color: #8b7355; border: none; padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer; }
    header { text-align: center; padding: 16px 0 24px; position: relative; }
    header h1 { font-family: 'Cormorant Garamond', serif; font-size: 2.2rem; font-weight: 500; color: #5c4d3c; letter-spacing: 3px; }
    header .subtitle { font-size: 0.85rem; color: #8b7d6b; margin-top: 4px; letter-spacing: 2px; }
    .main-card { background: white; border-radius: 24px; padding: 24px 20px; box-shadow: 0 8px 30px rgba(93, 77, 60, 0.1); margin-bottom: 20px; }
    .main-card h2 { font-family: 'Cormorant Garamond', serif; font-size: 1.4rem; color: #5c4d3c; margin-bottom: 6px; }
    .main-card p { color: #8b7d6b; font-size: 0.9rem; margin-bottom: 20px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 0.85rem; color: #5c4d3c; margin-bottom: 6px; font-weight: 500; }
    .form-group input, .form-group select { width: 100%; padding: 12px 14px; border: 1px solid #e5ddd3; border-radius: 12px; font-size: 16px; background: #faf7f2; color: #3d3527; font-family: 'Nunito', sans-serif; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #c9a96e; box-shadow: 0 0 0 3px rgba(201, 169, 110, 0.1); }
    .date-row { display: flex; gap: 8px; }
    .time-row { display: flex; gap: 8px; margin-top: 8px; }
    .time-row input { flex: 1; }
    .tz-row { margin-top: 8px; }
    .tz-row select { width: 100%; padding: 10px; border: 1px solid #e5ddd3; border-radius: 8px; font-size: 14px; background: #faf7f2; }
    .time-hint { font-size: 0.75rem; color: #a99d8d; margin-top: 4px; }
    .date-row select { flex: 1; }
    .btn-primary { width: 100%; padding: 14px; background: linear-gradient(135deg, #c9a96e 0%, #a68b5b 100%); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(166, 139, 91, 0.3); transition: transform 0.2s; }
    .btn-primary:active { transform: scale(0.98); }
    .btn-secondary { width: 100%; padding: 12px; background: transparent; color: #8b7d6b; border: 1px solid #e5ddd3; border-radius: 12px; font-size: 0.9rem; font-weight: 500; cursor: pointer; margin-top: 10px; }
    .traditions-title { font-family: 'Cormorant Garamond', serif; font-size: 1.1rem; color: #5c4d3c; text-align: center; margin-bottom: 12px; }
    .traditions-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px; }
    .tradition-card { background: white; border-radius: 20px; padding: 16px 12px; text-align: center; box-shadow: 0 4px 20px rgba(93, 77, 60, 0.08); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
    .tradition-card:active { transform: scale(0.97); }
    .tradition-card:hover { box-shadow: 0 6px 25px rgba(93, 77, 60, 0.15); }
    .tradition-card img { width: 70px; height: 70px; border-radius: 14px; margin-bottom: 10px; object-fit: cover; }
    .tradition-card h3 { font-size: 0.9rem; color: #5c4d3c; font-weight: 600; margin-bottom: 2px; }
    .tradition-card span { font-size: 0.7rem; color: #a99d8d; }
    footer { text-align: center; padding: 16px; color: #a99d8d; font-size: 0.8rem; }
    footer a { color: #c9a96e; text-decoration: none; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; padding: 20px; }
    .modal-overlay.active { display: flex; }
    .modal { background: white; border-radius: 24px; padding: 24px; max-width: 360px; width: 100%; max-height: 85vh; overflow-y: auto; position: relative; }
    .modal-close { position: absolute; top: 12px; right: 16px; font-size: 1.5rem; color: #a99d8d; cursor: pointer; border: none; background: none; }
    .modal-icon { width: 80px; height: 80px; margin: 0 auto 16px; display: block; border-radius: 16px; }
    .modal h3 { font-family: 'Cormorant Garamond', serif; font-size: 1.5rem; color: #5c4d3c; text-align: center; margin-bottom: 12px; }
    .modal p { color: #8b7d6b; font-size: 0.9rem; line-height: 1.6; margin-bottom: 16px; text-align: center; }
    .modal .form-group { margin-bottom: 12px; }
    .modal .date-row select { font-size: 14px; padding: 10px 8px; }
    .result-box { background: linear-gradient(135deg, #faf7f2 0%, #f5ede3 100%); border-radius: 16px; padding: 20px; text-align: center; margin-bottom: 16px; }
    .result-box .result-label { font-size: 0.8rem; color: #a99d8d; margin-bottom: 4px; }
    .result-box .result-value { font-family: 'Cormorant Garamond', serif; font-size: 1.8rem; color: #5c4d3c; font-weight: 600; }
    .result-box .result-sub { font-size: 0.85rem; color: #8b7d6b; margin-top: 4px; }
    .result-box .result-insight { margin-top: 14px; padding: 12px; background: white; border-radius: 12px; font-size: 0.9rem; color: #5c4d3c; font-style: italic; line-height: 1.4; }
    .hidden { display: none; }

    /* Modal Expandido Styles */
    .result-box { background: #faf7f2; border-radius: 16px; padding: 20px; margin-bottom: 16px; border: 1px solid #e5ddd3; }
    .result-label { font-size: 0.8rem; color: #a99d8d; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
    .result-value { font-family: 'Cormorant Garamond', serif; font-size: 1.6rem; color: #5c4d3c; font-weight: 600; margin-bottom: 4px; }
    .result-sub { font-size: 0.9rem; color: #8b7d6b; margin-bottom: 12px; }
    .result-divider { height: 1px; background: #e5ddd3; margin: 16px 0; }
    .result-section-title { font-size: 0.75rem; color: #a99d8d; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 8px; text-align: center; }
    .result-personality { font-size: 0.95rem; color: #5c4d3c; line-height: 1.6; text-align: center; margin-bottom: 16px; }
    .result-today { background: linear-gradient(135deg, #fdf8f0 0%, #f5efe5 100%); border-radius: 12px; padding: 14px; margin-bottom: 16px; }
    .result-today-title { font-size: 0.75rem; color: #c9a96e; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
    .result-today-text { font-size: 0.9rem; color: #6b5b4f; line-height: 1.5; font-style: italic; }
    .btn-profundizar { width: 100%; padding: 14px; background: linear-gradient(135deg, #c9a96e 0%, #b8955c 100%); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-bottom: 12px; box-shadow: 0 4px 15px rgba(201, 169, 110, 0.3); transition: transform 0.2s, box-shadow 0.2s; }
    .btn-profundizar:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(201, 169, 110, 0.4); }
    .btn-profundizar:active { transform: scale(0.98); }
    .btn-profundizar:disabled { background: #d4c9b8; cursor: not-allowed; transform: none; box-shadow: none; }
    .profundizar-result { background: #fff; border: 1px solid #e5ddd3; border-radius: 12px; padding: 16px; margin-top: 12px; display: none; }
    .profundizar-result.active { display: block; }
    .profundizar-text { font-size: 0.9rem; color: #5c4d3c; line-height: 1.7; }
    .profundizar-loading { text-align: center; color: #a99d8d; font-size: 0.9rem; }

  </style>

  <!-- Analytics: Plausible (privacy-friendly, no cookies) -->
  <script defer data-domain="astro3-lovat.vercel.app" src="https://plausible.io/js/script.js"></script>
  <script>
    // Custom events helper
    window.trackEvent = function(name, props) {
      if (window.plausible) {
        window.plausible(name, {props: props});
      }
    };
  </script>
</head>
<body>
  <canvas id="starfield-index"></canvas>

  <div class="container">
    <div class="lang-toggle">
      <button class="lang-btn active" onclick="setLang('es')" id="btn-es">ES</button>
      <button class="lang-btn" onclick="setLang('en')" id="btn-en">EN</button>
    </div>
    <div class="install-banner" id="installBanner">
      <p data-i18n="install">üì≤ Instala ASTRO4</p>
      <button onclick="installApp()" data-i18n="installBtn">Instalar</button>
    </div>
    <header>
      <h1>‚úß ASTRO4 ‚úß</h1>
      <p class="subtitle" data-i18n="subtitle">Tu Gu√≠a C√≥smica Personal</p>
    </header>
    <div class="main-card">
      <h2 data-i18n="discover">Descubre tu energ√≠a de hoy</h2>
      <p data-i18n="traditions">4 tradiciones ancestrales te gu√≠an.</p>
      <form id="onboarding-form">
        <div class="form-group">
          <label data-i18n="nameLabel">Tu nombre</label>
          <input type="text" id="nombre" data-i18n-placeholder="namePlaceholder" placeholder="¬øC√≥mo te llamas?" required>
        </div>
        <div class="form-group">
          <label data-i18n="birthLabel">Fecha de nacimiento</label>
          <div class="date-row">
            <select id="dia" required><option value="" data-i18n="day">D√≠a</option></select>
            <select id="mes" required><option value="" data-i18n="month">Mes</option></select>
            <select id="anio" required><option value="" data-i18n="year">A√±o</option></select>
          </div>
          <div class="time-row">
            <input type="time" id="hora" value="12:00">
          </div>
          <div class="tz-row">
            <select id="timezone">
              <option value="auto" data-i18n="tzAuto">Detectar automaticamente</option>
              <option value="-12">UTC-12 (Baker Island)</option>
              <option value="-11">UTC-11 (Samoa)</option>
              <option value="-10">UTC-10 (Hawaii)</option>
              <option value="-9">UTC-9 (Alaska)</option>
              <option value="-8">UTC-8 (Los Angeles)</option>
              <option value="-7">UTC-7 (Denver)</option>
              <option value="-6">UTC-6 (Mexico City)</option>
              <option value="-5">UTC-5 (New York)</option>
              <option value="-4">UTC-4 (Santiago)</option>
              <option value="-3">UTC-3 (Buenos Aires)</option>
              <option value="0">UTC+0 (London)</option>
              <option value="1">UTC+1 (Paris, Madrid)</option>
              <option value="2">UTC+2 (Cairo)</option>
              <option value="3">UTC+3 (Moscow)</option>
              <option value="4">UTC+4 (Dubai)</option>
              <option value="5">UTC+5 (Karachi)</option>
              <option value="5.5">UTC+5:30 (India)</option>
              <option value="6">UTC+6 (Dhaka)</option>
              <option value="7">UTC+7 (Bangkok)</option>
              <option value="8">UTC+8 (Beijing, Singapore)</option>
              <option value="9">UTC+9 (Tokyo)</option>
              <option value="10">UTC+10 (Sydney)</option>
              <option value="12">UTC+12 (Auckland)</option>
            </select>
          </div>
          <div class="time-hint" data-i18n="timeHint">Hora aproximada - opcional para mayor precision</div>
        </div>
        <button type="submit" class="btn-primary" data-i18n="revealBtn">‚ú® Revelar mi energ√≠a</button>
      </form>
    </div>
    <p class="traditions-title" data-i18n="learnMore">Conoce las tradiciones:</p>
    <div class="traditions-grid">
      <div class="tradition-card" onclick="openModal('western')">
        <img src="Sol.jpeg" alt="Occidental">
        <h3 data-i18n="western">Occidental</h3>
        <span data-i18n="westernSub">Zodiaco solar</span>
      </div>
      <div class="tradition-card" onclick="openModal('vedic')">
        <img src="Luna.jpeg" alt="V√©dico">
        <h3 data-i18n="vedic">V√©dico</h3>
        <span data-i18n="vedicSub">Nakshatra lunar</span>
      </div>
      <div class="tradition-card" onclick="openModal('chinese')">
        <img src="Dragon.jpeg" alt="Chino">
        <h3 data-i18n="chinese">Chino</h3>
        <span data-i18n="chineseSub">Animal y elemento</span>
      </div>
      <div class="tradition-card" onclick="openModal('numerology')">
        <img src="Numeros.jpeg" alt="Numerolog√≠a">
        <h3 data-i18n="numerology">Numerolog√≠a</h3>
        <span data-i18n="numerologySub">N√∫meros de vida</span>
      </div>
    </div>
    <footer>
      <p>üêù <span data-i18n="madeWith">Hecho con ‚ô• por</span> <a href="#">Colmena (C6)</a></p>
      <p><a href="#" onclick="showPrivacy()" data-i18n="privacy">Privacidad</a></p>
    </footer>
  </div>
  <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <button class="modal-close" onclick="closeModal()">√ó</button>
      <img class="modal-icon" id="modalIcon" src="" alt="">
      <h3 id="modalTitle"></h3>
      <p id="modalDesc"></p>
      <div id="modalFormSection">
        <div class="form-group">
          <label id="modalNameLabel">Tu nombre</label>
          <input type="text" id="modalNombre" placeholder="¬øC√≥mo te llamas?">
        </div>
        <div class="form-group">
          <label id="modalBirthLabel">Fecha de nacimiento</label>
          <div class="date-row">
            <select id="modalDia"><option value="">D√≠a</option></select>
            <select id="modalMes"><option value="">Mes</option></select>
            <select id="modalAnio"><option value="">A√±o</option></select>
          </div>
        </div>
        <button class="btn-primary" onclick="revealSingle()" id="modalBtn">‚ú® Revelar esta energ√≠a</button>
      </div>
      <div id="modalResultSection" class="hidden">
        <div class="result-box">
          <div class="result-label" id="resultLabel"></div>
          <div class="result-value" id="resultValue"></div>
          <div class="result-sub" id="resultSub"></div>
          
          <div class="result-divider"></div>
          
          <div class="result-section-title" id="personalityTitle">Tu Personalidad</div>
          <div class="result-personality" id="resultPersonality"></div>
          
          <div class="result-today">
            <div class="result-today-title" id="todayTitle">‚ú® Hoy Para Ti</div>
            <div class="result-today-text" id="resultInsight"></div>
          </div>
          
          <button class="btn-profundizar" id="btnProfundizar" onclick="profundizarTradicion()">‚ú® Profundizar con IA</button>
          <div class="profundizar-result" id="profundizarResult">
            <div class="profundizar-loading" id="profundizarLoading">Consultando tu gu√≠a c√≥smica...</div>
            <div class="profundizar-text" id="profundizarText"></div>
          </div>
        </div>
        <button class="btn-secondary" onclick="resetModal()" id="btnTryAnother">‚Üê Volver</button>
      </div>
    </div>
  </div>
  <script src="js/astro-calc.js"></script>
  <script src="js/sign-descriptions.js"></script>
  <script src="js/mini-insights.js"></script>
  <script>
    const traditions = {
      western: { icon: 'Sol.jpeg', titleEs: '‚òÄÔ∏è Astrolog√≠a Occidental', titleEn: '‚òÄÔ∏è Western Astrology', descEs: 'Basada en la posici√≥n del Sol al nacer. Los 12 signos zodiacales revelan tu personalidad.', descEn: 'Based on the Sun position at birth. The 12 zodiac signs reveal your personality.', labelEs: 'Tu signo solar', labelEn: 'Your sun sign' },
      vedic: { icon: 'Luna.jpeg', titleEs: 'üïâÔ∏è Astrolog√≠a V√©dica', titleEn: 'üïâÔ∏è Vedic Astrology', descEs: 'Tradici√≥n milenaria de la India basada en la Luna y los Nakshatras.', descEn: 'Ancient Indian tradition based on the Moon and Nakshatras.', labelEs: 'Tu Nakshatra', labelEn: 'Your Nakshatra' },
      chinese: { icon: 'Dragon.jpeg', titleEs: 'üêâ Astrolog√≠a China', titleEn: 'üêâ Chinese Astrology', descEs: 'Sistema de 12 animales y 5 elementos basado en tu a√±o lunar.', descEn: 'System of 12 animals and 5 elements based on your lunar year.', labelEs: 'Tu animal chino', labelEn: 'Your Chinese animal' },
      numerology: { icon: 'Numeros.jpeg', titleEs: 'üî¢ Numerolog√≠a', titleEn: 'üî¢ Numerology', descEs: 'El poder de los n√∫meros revela tu misi√≥n y lecciones de vida.', descEn: 'The power of numbers reveals your mission and life lessons.', labelEs: 'Tu N√∫mero de Vida', labelEn: 'Your Life Number' }
    };
    let currentModal = null;
    const i18n = {
      es: {
        timeHint: "Hora aproximada - opcional para mayor precisi√≥n",
        tzAuto: "Detectar autom√°ticamente",
        tzLabel: "Zona horaria de nacimiento", install: "üì≤ Instala ASTRO4", installBtn: "Instalar", subtitle: "Tu Gu√≠a C√≥smica Personal", discover: "Descubre tu energ√≠a de hoy", traditions: "4 tradiciones ancestrales te gu√≠an.", nameLabel: "Tu nombre", namePlaceholder: "¬øC√≥mo te llamas?", birthLabel: "Fecha de nacimiento", day: "D√≠a", month: "Mes", year: "A√±o", revealBtn: "‚ú® Revelar mi energ√≠a", revealSingle: "‚ú® Revelar esta energ√≠a", western: "Occidental", westernSub: "Zodiaco solar", vedic: "V√©dico", vedicSub: "Nakshatra lunar", chinese: "Chino", chineseSub: "Animal y elemento", numerology: "Numerolog√≠a", numerologySub: "N√∫meros de vida", madeWith: "Hecho con ‚ô• por", privacy: "Privacidad", privacyMsg: "ASTRO4 respeta tu privacidad.", months: ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"], learnMore: "Conoce las tradiciones:", back: "‚Üê Volver", personalityTitle: "Tu Personalidad", todayTitle: "‚ú® Hoy Para Ti", profundizarBtn: "‚ú® Profundizar con IA", profundizarLoading: "Consultando tu gu√≠a c√≥smica..." },
      en: {
        timeHint: "Approximate time - optional for better accuracy",
        tzAuto: "Detect automatically",
        tzLabel: "Birth timezone", install: "üì≤ Install ASTRO4", installBtn: "Install", subtitle: "Your Personal Cosmic Guide", discover: "Discover your energy today", traditions: "4 ancestral traditions guide you.", nameLabel: "Your name", namePlaceholder: "What's your name?", birthLabel: "Date of birth", day: "Day", month: "Month", year: "Year", revealBtn: "‚ú® Reveal my energy", revealSingle: "‚ú® Reveal this energy", western: "Western", westernSub: "Solar zodiac", vedic: "Vedic", vedicSub: "Lunar nakshatra", chinese: "Chinese", chineseSub: "Animal & element", numerology: "Numerology", numerologySub: "Life numbers", madeWith: "Made with ‚ô• by", privacy: "Privacy", privacyMsg: "ASTRO4 respects your privacy.", months: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"], learnMore: "Learn about traditions:", back: "‚Üê Back", personalityTitle: "Your Personality", todayTitle: "‚ú® Today For You", profundizarBtn: "‚ú® Deepen with AI", profundizarLoading: "Consulting your cosmic guide..." }
    };
    let currentLang = localStorage.getItem('astro4_lang') || 'es';
    function openModal(type) {
      currentModal = type;
      const t = traditions[type];
      document.getElementById('modalIcon').src = t.icon;
      document.getElementById('modalTitle').textContent = currentLang === 'es' ? t.titleEs : t.titleEn;
      document.getElementById('modalDesc').textContent = currentLang === 'es' ? t.descEs : t.descEn;
      document.getElementById('modalBtn').textContent = i18n[currentLang].revealSingle;
      document.getElementById('modalNameLabel').textContent = i18n[currentLang].nameLabel;
      document.getElementById('modalBirthLabel').textContent = i18n[currentLang].birthLabel;
      document.getElementById('modalNombre').placeholder = i18n[currentLang].namePlaceholder;
      document.getElementById('btnTryAnother').textContent = i18n[currentLang].back;
      document.getElementById('modalNombre').value = document.getElementById('nombre').value;
      document.getElementById('modalDia').value = document.getElementById('dia').value;
      document.getElementById('modalMes').value = document.getElementById('mes').value;
      document.getElementById('modalAnio').value = document.getElementById('anio').value;
      document.getElementById('modalFormSection').classList.remove('hidden');
      document.getElementById('modalResultSection').classList.add('hidden');
      document.getElementById('modalOverlay').classList.add('active');
    }
    function closeModal(e) { if (!e || e.target === document.getElementById('modalOverlay')) { document.getElementById('modalOverlay').classList.remove('active'); } }
    function resetModal() { document.getElementById('modalFormSection').classList.remove('hidden'); document.getElementById('modalResultSection').classList.add('hidden'); }
    function revealSingle() {
      const nombre = document.getElementById('modalNombre').value;
      const dia = document.getElementById('modalDia').value;
      const mes = document.getElementById('modalMes').value;
      const anio = document.getElementById('modalAnio').value;
      if (!nombre || !dia || !mes || !anio) { document.getElementById('modalNombre').focus(); return; }
      document.getElementById('nombre').value = nombre;
      document.getElementById('dia').value = dia;
      document.getElementById('mes').value = mes;
      document.getElementById('anio').value = anio;
      let mesF = mes.length === 1 ? '0' + mes : mes;
      let diaF = dia.length === 1 ? '0' + dia : dia;
      const birthDate = new Date(anio + '-' + mesF + '-' + diaF + 'T12:00:00');
      const t = traditions[currentModal];
      let label = currentLang === 'es' ? t.labelEs : t.labelEn;
      let value = '', sub = '', insightKey = '';
      if (currentModal === 'western') {
        const sign = getWesternSign(birthDate, currentLang);
        value = sign.name; sub = (currentLang === 'es' ? 'Elemento: ' : 'Element: ') + sign.element;
        insightKey = sign.name;
      } else if (currentModal === 'chinese') {
        const chinese = getChineseZodiac(birthDate, currentLang);
        value = chinese.animal; sub = chinese.element + ' ¬∑ ' + chinese.yinYang;
        insightKey = chinese.animal;
      } else if (currentModal === 'vedic') {
        const vedic = getNakshatra(birthDate);
        value = vedic.nakshatra; sub = currentLang === 'es' ? 'Constelaci√≥n lunar' : 'Lunar mansion';
        insightKey = vedic.nakshatra;
      } else if (currentModal === 'numerology') {
        const num = getNumerology(birthDate, nombre, currentLang);
        value = num.lifeNumber; sub = num.lifeMeaning.keyword + ' - ' + num.lifeMeaning.desc;
        insightKey = num.lifeNumber;
      }
      const insight = getMiniInsight(currentModal, insightKey, currentLang, birthDate);
      const desc = typeof getSignDescription === 'function' ? getSignDescription(currentModal, insightKey, currentLang) : '';
      document.getElementById('resultLabel').textContent = label;
      document.getElementById('resultValue').textContent = value;
      document.getElementById('resultSub').textContent = sub;
      document.getElementById('resultInsight').textContent = insight ? '‚ú® ' + insight : '';
      document.getElementById('resultPersonality').textContent = desc || '';
      currentResult = { tradition: currentModal, sign: insightKey, nombre: nombre, birthDate: birthDate };
      document.getElementById('profundizarResult').classList.remove('active');
      document.getElementById('modalFormSection').classList.add('hidden');
      document.getElementById('modalResultSection').classList.remove('hidden');
    }

    // Store current result for profundizar
    var currentResult = { tradition: '', sign: '', nombre: '', birthDate: null };
    
    async function profundizarTradicion() {
      const btn = document.getElementById('btnProfundizar');
      const resultDiv = document.getElementById('profundizarResult');
      const loadingDiv = document.getElementById('profundizarLoading');
      const textDiv = document.getElementById('profundizarText');
      
      btn.disabled = true;
      btn.textContent = currentLang === 'es' ? 'Consultando...' : 'Consulting...';
      resultDiv.classList.add('active');
      loadingDiv.style.display = 'block';
      textDiv.style.display = 'none';
      
      try {
        const response = await fetch('/api/profundizar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tradition: currentResult.tradition,
            sign: currentResult.sign,
            nombre: currentResult.nombre,
            lang: currentLang
          })
        });
        
        const data = await response.json();
        loadingDiv.style.display = 'none';
        textDiv.style.display = 'block';
        textDiv.textContent = data.respuesta || (currentLang === 'es' ? 'No se pudo obtener la lectura.' : 'Could not get the reading.');
      } catch (error) {
        loadingDiv.style.display = 'none';
        textDiv.style.display = 'block';
        textDiv.textContent = currentLang === 'es' ? 'Error de conexi√≥n. Intenta de nuevo.' : 'Connection error. Try again.';
      }
      
      btn.disabled = false;
      btn.textContent = currentLang === 'es' ? '‚ú® Profundizar con IA' : '‚ú® Deepen with AI';
    }

    function setLang(lang) {
      currentLang = lang; localStorage.setItem('astro4_lang', lang); document.documentElement.lang = lang;
      document.getElementById('btn-es').classList.toggle('active', lang === 'es');
      document.getElementById('btn-en').classList.toggle('active', lang === 'en');
      document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if (i18n[lang][key]) el.textContent = i18n[lang][key]; });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => { const key = el.getAttribute('data-i18n-placeholder'); if (i18n[lang][key]) el.placeholder = i18n[lang][key]; });
      updateMonths(); updateModalSelects();
    }
    function updateMonths() { const mesSelect = document.getElementById('mes'); mesSelect.innerHTML = '<option value="">' + i18n[currentLang].month + '</option>'; i18n[currentLang].months.forEach((m, idx) => { mesSelect.innerHTML += '<option value="' + (idx+1) + '">' + m + '</option>'; }); }
    function updateModalSelects() {
      const modalDia = document.getElementById('modalDia'), modalMes = document.getElementById('modalMes'), modalAnio = document.getElementById('modalAnio');
      modalDia.innerHTML = '<option value="">' + i18n[currentLang].day + '</option>'; for(let i=1; i<=31; i++) { modalDia.innerHTML += '<option value="'+i+'">'+i+'</option>'; }
      modalMes.innerHTML = '<option value="">' + i18n[currentLang].month + '</option>'; i18n[currentLang].months.forEach((m, idx) => { modalMes.innerHTML += '<option value="' + (idx+1) + '">' + m + '</option>'; });
      modalAnio.innerHTML = '<option value="">' + i18n[currentLang].year + '</option>'; for(let i=2010; i>=1920; i--) { modalAnio.innerHTML += '<option value="'+i+'">'+i+'</option>'; }
    }
    function showPrivacy() { alert(i18n[currentLang].privacyMsg); }
    function initPage() { const diaSelect = document.getElementById('dia'); for(let i=1; i<=31; i++) { diaSelect.innerHTML += '<option value="'+i+'">'+i+'</option>'; } const anioSelect = document.getElementById('anio'); for(let i=2010; i>=1920; i--) { anioSelect.innerHTML += '<option value="'+i+'">'+i+'</option>'; } setLang(currentLang); }
    initPage();
    let deferredPrompt; window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });
    function installApp() { if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then((result) => { if (result.outcome === 'accepted') { document.getElementById('installBanner').style.display = 'none'; } deferredPrompt = null; }); } else { alert(currentLang === 'es' ? 'Para instalar:\n1. Toca el men√∫ ‚ãÆ\n2. Selecciona "A√±adir a pantalla de inicio"' : 'To install:\n1. Tap menu ‚ãÆ\n2. Select "Add to Home Screen"'); } }
    if (window.matchMedia('(display-mode: standalone)').matches) { document.getElementById('installBanner').style.display = 'none'; }
    document.getElementById('onboarding-form').addEventListener('submit', function(e) { e.preventDefault(); var nombre = document.getElementById('nombre').value; var dia = document.getElementById('dia').value; var mes = document.getElementById('mes').value; var anio = document.getElementById('anio').value; if(mes.length === 1) mes = '0' + mes; if(dia.length === 1) dia = '0' + dia; var fecha = anio + '-' + mes + '-' + dia; var hora = document.getElementById('hora').value || '12:00'; var tz = document.getElementById('timezone').value; if(tz === 'auto') tz = (-new Date().getTimezoneOffset()/60).toString(); window.location.href = 'app.html?nombre=' + encodeURIComponent(nombre) + '&fecha=' + fecha + '&hora=' + hora + '&tz=' + tz + '&lang=' + currentLang; });
  
    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('[SW] Registered'))
          .catch(err => console.log('[SW] Error:', err));
      });
    }

  
    // ===== PERSISTENCIA USUARIO (Tarea 2.1) =====
    function saveUserData() {
      const nombre = document.getElementById('nombre').value;
      const dia = document.getElementById('dia').value;
      const mes = document.getElementById('mes').value;
      const anio = document.getElementById('anio').value;
      
      if (nombre) localStorage.setItem('astro4_name', nombre);
      if (dia && mes && anio) {
        var hora = document.getElementById('hora').value || '12:00';
        var tz = document.getElementById('timezone').value;
        if(tz === 'auto') tz = (-new Date().getTimezoneOffset()/60).toString();
        localStorage.setItem('astro4_birthdate', JSON.stringify({dia, mes, anio, hora, tz}));
      }
    }
    
    function loadUserData() {
      // Cargar nombre
      const savedName = localStorage.getItem('astro4_name');
      if (savedName) {
        document.getElementById('nombre').value = savedName;
      }
      
      // Cargar fecha
      const savedBirth = localStorage.getItem('astro4_birthdate');
      if (savedBirth) {
        try {
          const birth = JSON.parse(savedBirth);
          if (birth.dia) document.getElementById('dia').value = birth.dia;
          if (birth.mes) document.getElementById('mes').value = birth.mes;
          if (birth.anio) document.getElementById('anio').value = birth.anio;
        } catch(e) {}
      }
    }
    
    // Guardar al cambiar campos
    document.addEventListener('DOMContentLoaded', function() {
      loadUserData();
      
      // Event listeners para guardar
      document.getElementById('nombre').addEventListener('change', saveUserData);
      document.getElementById('dia').addEventListener('change', saveUserData);
      document.getElementById('mes').addEventListener('change', saveUserData);
      document.getElementById('anio').addEventListener('change', saveUserData);
    });

  </script>

  <!-- Theme Toggle Button -->
  <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn" title="Cambiar tema">üåô</button>

  <!-- Starfield Script -->
  <script>
    // Inicializar tema
    (function() {
      var saved = localStorage.getItem('astro4_theme');
      if (saved === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.getElementById('themeBtn').textContent = '‚òÄÔ∏è';
      }
    })();
    
    function toggleTheme() {
      var current = document.documentElement.getAttribute('data-theme');
      var btn = document.getElementById('themeBtn');
      if (current === 'dark') {
        document.documentElement.removeAttribute('data-theme');
        localStorage.setItem('astro4_theme', 'light');
        btn.textContent = 'üåô';
      } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('astro4_theme', 'dark');
        btn.textContent = '‚òÄÔ∏è';
      }
    }
    
    // Starfield
    (function() {
      const canvas = document.getElementById('starfield-index');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      let stars = [];
      const STAR_COUNT = 150;
      
      function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      
      class Star {
        constructor() { this.reset(); }
        reset() {
          this.x = Math.random() * canvas.width;
          this.y = Math.random() * canvas.height;
          this.size = Math.random() * 1.5 + 0.5;
          this.speed = Math.random() * 0.3 + 0.1;
          this.brightness = Math.random();
          this.twinkleSpeed = Math.random() * 0.02 + 0.01;
        }
        update() {
          this.y += this.speed;
          this.brightness = Math.sin(Date.now() * this.twinkleSpeed) * 0.3 + 0.7;
          if (this.y > canvas.height) { this.y = 0; this.x = Math.random() * canvas.width; }
        }
        draw() {
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fillStyle = 'rgba(212, 184, 150, ' + (this.brightness * 0.6) + ')';
          ctx.fill();
        }
      }
      
      function init() {
        resize();
        stars = Array.from({ length: STAR_COUNT }, () => new Star());
        animate();
      }
      
      function animate() {
        if (document.documentElement.getAttribute('data-theme') !== 'dark') {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          requestAnimationFrame(animate);
          return;
        }
        ctx.fillStyle = 'rgba(10, 10, 15, 0.2)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        stars.forEach(star => { star.update(); star.draw(); });
        requestAnimationFrame(animate);
      }
      
      window.addEventListener('resize', resize);
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>

</body>
</html>